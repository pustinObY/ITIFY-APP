/**
 * CodeDropz Uploader v1.0.7
 * Copyright 2019 Glen Mongaya
 * CodeDropz - Drag & Drop Uploader
 * @version 1.0.7
 * @author CodeDropz, Glen Don L. Mongaya
 * @license The MIT License (MIT)
 */

!function(e){e.fn.CodeDropz_Uploader_WC=function(a){var r=[],s=[];this.each(function(){var o=e(this),t=e.extend({is_pro:!1,handler:o,form:o.parents("form"),color:"#000",background:"",upload_dir:null,server_max_error:"Uploaded file exceeds the maximum upload size of your server.",max_file:o.data("max")?o.data("max"):5,max_upload_size:o.data("limit")?o.data("limit"):"10485760",supported_type:o.data("type")?o.data("type"):"jpg|jpeg|JPG|png|gif|pdf|doc|docx|ppt|pptx|odt|avi|ogg|m4a|mov|mp3|mp4|mpg|wav|wmv|xls",max_total_size:"100MB",parallel_uploads:2,chunks:!1,chunk_size:1e4,text:"Drag & Drop Files Here",separator:"or",button_text:"Browse Files",err_message:{maxNumFiles:"You have reached the maximum number of files ( Only %s files allowed )",maxUploadLimit:"Note : Some of the files could not be uploaded ( Only %s files allowed )",maxTotalSize:"The total file(s) size exceeding the max size limit of %s."},on_success:"",in_progress:"",completed:""},a),n=t.parallel_uploads,d=t.chunks,i=t.chunk_size,l="codedropz--results",p=1048576*parseInt(t.max_total_size.replace("[^0-9]/g","")),u=o.data("name"),c='<div class="codedropz-upload-handler wc-upload-wrap"><div class="codedropz-upload-container"><div class="codedropz-upload-inner"><div class="codedropz-label"><span class="cd-icon"><i class="icon-cloud-upload"></i></span><span class="text">'+t.text+'</span><span class="cd-separator">'+t.separator+'</span><a class="cd-upload-btn" href="javascript:void(0)">'+t.button_text+'</a></div></div></div><span class="dnd-upload-counter"><span>0</span> '+dnd_wc_uploader.uploader_text.of+" "+parseInt(t.max_file)+"</span></div>";t.handler.wrapAll('<div class="codedropz-upload-wrapper"></div>');var h=t.form,m=t.handler.parents(".codedropz-upload-wrapper");t.handler.after(c);var f={init:function(){var a=this;u=this.getFieldName(u),s[u]=[],r[u]={total:0,uploaded:0,uploading:!0,maxTotalSize:0,maxSize:t.max_upload_size,maxFile:t.max_file},e(".codedropz-upload-handler",m).on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation()}),e(".codedropz-upload-handler",m).on("dragover dragenter",function(a){e(this).addClass("codedropz-dragover")}),e(".codedropz-upload-handler",m).on("dragleave dragend drop",function(a){e(this).removeClass("codedropz-dragover")}),!e("."+l,m).length>0&&m.append('<div class="'+l+'"></div>'),this.getUploadFiles(),e(document).on("click","a.remove-file",function(r){e(this).hasClass("deleting")||a.deleteFiles(e(this).data("index"),e(this),e(this).data("name"))})},getFieldName:function(e){return e.replace(/[^a-zA-Z0-9_-]/g,"")},deleteFiles:function(a,r,o){var n,d=s[o],i=this;r.addClass("deleting").text(dnd_wc_uploader.uploader_text.delete);for(var l=0;l<d.length;l++)if(n=d[l],d[l].hasOwnProperty("file")&&("undefined"===e.type(a)||n.index===a))if(n.queued&&0==n.complete&&!n.error)r.addClass("deleting").text("aborting..."),this.abortFile(n),this.removeFile(n,l,o);else if(n.complete){var p={_file:n,_index:l,_name:o};data={action:"dnd_codedropz_upload_delete_wc",security:dnd_wc_uploader.nonce,path:e('input[data-index="'+n.progressbar+'"]').val()},e.post(t.ajax_url,data,function(e){e.success&&(i.removeFile(p._file,p._index,p._name),console.log(p._file.name+" - file deleted."))})}else this.removeFile(n,l,o)},abortFile:function(e){d?e.chunkTransfer&&e.chunkTransfer.abort():e.transfer.abort()},removeFile:function(a,s,o){var n=e("#"+a.progressbar).parents(".codedropz-upload-wrapper");a&&a.hasOwnProperty("file")&&null!=a.progressbar&&(progressBar=n.find("#"+a.progressbar),progressBar.length>0?(a.deleted=!0,r[o].total--,r[o].maxTotalSize=r[o].maxTotalSize-a.size,a.complete&&r[o].uploaded>0&&r[o].uploaded--,progressBar.remove(),e('input[data-index="'+a.progressbar+'"]').remove(),this.resetQueue(o)):console.log("Progress Bar not exists!"),r[o].uploaded<r[o].maxFile&&n.find("span.has-error-msg").remove(),r[o].maxTotalSize>p&&1==t.is_pro&&(m=n,this.validateFiles.setError(t.err_message.maxTotalSize,!1,t.max_total_size)),e(".dnd-upload-counter span",e('input[data-name="'+o+'"]').parents(".codedropz-upload-wrapper")).text(r[o].total))},getUploadFiles:function(){var a=this;e(".codedropz-upload-handler",m).on("drop",function(e){a.handleFiles(e.originalEvent.dataTransfer.files)}),e("a.cd-upload-btn",m).on("click",function(e){e.preventDefault(),t.handler.val(null),t.handler.click()}),t.handler.on("change",function(e){a.handleFiles(this.files)})},handleFiles:function(a){var o=a.length,n=[];if(r[u].maxFile){var d=r[u].maxFile-r[u].uploaded;d>=0&&a.length>d&&(o=d),0==r[u].uploaded&&r[u].total>0&&(o=r[u].maxFile-r[u].total)}if(e("span.has-error-msg",m).remove(),r[u].total>=r[u].maxFile)return this.validateFiles.setError(t.err_message.maxNumFiles,!0,t.max_file);if(o>0)for(var i=0;i<o;i++)$unique_index="index-"+Date.now().toString(36)+Math.random().toString(36).substr(2,5),n={index:$unique_index,file:a[i],name:a[i].name,size:a[i].size,queued:!1,complete:!1,error:!1,pause:!1,transfer:null,progressbar:null,deleted:!1},a.length-o>0&&this.validateFiles.setError(t.err_message.maxUploadLimit,!1,t.max_file),r[u].total++,r[u].maxTotalSize+=n.size,n.progressbar=this.progressBar.make(n),!1===this.validateFiles.check(n,u)&&(n.error=!0),r[u].maxTotalSize>p&&1==t.is_pro&&(this.validateFiles.setError(t.err_message.maxTotalSize,!0,t.max_total_size),n.pause=!0),s[u].push(n);r[u].uploading=!0,this.processQueue(s[u],u)},validateFiles:{setError:function(a,r,s){if(e("span.has-error-msg",m).remove(),e("."+l,m).after('<span class="has-error-msg">'+a.replace("%s",s)+"</span>"),r)return!1},check:function(a,s){if(!a)return!0;if(a.progressbar){var o=e("#"+a.progressbar).find(".dnd-upload-details");if(e("#"+a.progressbar).find(".has-error").remove(),a.size>r[s].maxSize)return o.append('<span class="has-error">'+dnd_wc_uploader.drag_n_drop_upload.large_file+"</span>"),!1;if(regex_type=new RegExp("(.*?).("+t.supported_type+")$"),!regex_type.test(a.name.toLowerCase()))return o.append('<span class="has-error">'+dnd_wc_uploader.drag_n_drop_upload.inavalid_type+"</span>"),!1}return a}},resetQueue:function(e){var a=[];if(r[e].uploading=!0,s[e].length>0)for(var o in s[e])1==!s[e][o].deleted&&a.push(s[e][o]),1==s[e][o].pause&&r[e].maxTotalSize<p&&(s[e][o].pause=!1);a.length>0&&(s[e]=a),this.processQueue(s[e],e),console.log(s[e]),console.log(r[e]),console.log(f.bytesToSize(r[e].maxTotalSize)+" of "+t.max_total_size)},processQueue:function(a,o){var d=0,i=[];if(r[o].uploading){for(var l in a)0==a[l].complete&&0==a[l].error&&0==a[l].pause&&i.push(a[l]);e.isFunction(t.in_progress)&&t.in_progress.call(this,h,i,s[o]);for(l=0;l<i.length;l++)if(i[l].hasOwnProperty("file")&&(0==i[l].queued&&this.uploadFile(s[o],i[l],o),++d>=n&&1==t.is_pro))return;0==d&&(r[o].uploading=!1,e.isFunction(t.completed)&&t.completed.call(this,h,o,s[o]))}},progressBar:{make:function(a){var r="dnd-file-"+Math.random().toString(36).substr(2,9),s='<div class="dnd-upload-image"><span class="icon-images"></span></div><div class="dnd-upload-details"><span class="name"><span>'+a.name+"</span> <em>("+f.bytesToSize(a.size)+')</em></span><a href="javascript:void(0)" title="'+dnd_wc_uploader.uploader_text.remove+'" class="remove-file" data-name="'+u+'" data-index="'+a.index+'"><span class="icon-close-outline"></span></a><span class="dnd-progress-bar"><span></span></span></div>';return e("."+l,m).append('<div id="'+r+'" class="dnd-upload-status">'+s+"</div>"),r},setProgress:function(a,r){var s=e(".dnd-progress-bar",e("#"+a));return s.length>0&&(progress_width=r*s.width()/100,e("span",s).addClass("in-progress").animate({width:progress_width},10).text(r+"% "),100==r&&e("span",s).addClass("complete").removeClass("in-progress")),!1}},uploadFile:function(a,s,o){var n=this,l=new FormData,p=1024*i;l.append("supported_type",t.supported_type),l.append("size_limit",t.max_upload_size),l.append("action","dnd_codedropz_upload_wc"),d&&s.size>p&&1==t.is_pro?(s.queued=!0,s.chunkSize=p,s.totalChunks=Math.ceil(s.size/s.chunkSize),s.currentChunk=0,this.uploadChunks(a,s,o)):(s.queued=!0,l.append("dnd-wc-upload-file",s.file),s.transfer=e.ajax({url:t.ajax_url,type:h.attr("method"),data:l,dataType:"json",cache:!1,contentType:!1,processData:!1,xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var a=e.loaded/e.total,r=parseInt(100*a);n.progressBar.setProgress(s.progressbar,r)}},!1),e},complete:function(){n.progressBar.setProgress(s.progressbar,100)},success:function(d){d.success?(s.complete=!0,r[o].uploaded++,n.processQueue(a,o),e.isFunction(t.on_success)&&t.on_success.call(this,s.progressbar,d,o,r[o])):(e("#"+s.progressbar).find(".dnd-upload-details").append('<span class="has-error">'+d.data+"</span>"),s.error=!0,n.processQueue(a,o))},error:function(r,t,d){e("#"+s.progressbar).find(".dnd-upload-details").append('<span class="has-error">'+d+"</span>"),s.error=!0,n.processQueue(a,o)}}))},uploadChunks:function(a,s,n){var d=s.chunkSize*s.currentChunk,i=d+s.chunkSize,l=this;i>s.size&&(i=s.size);var p=this.sliceFile(s.file,d,i),u=new FormData;u.append("start",d),u.append("end",i),u.append("total_chunks",s.totalChunks),u.append("chunk_size",s.chunkSize),u.append("chunk",s.currentChunk),u.append("chunks-file",p,s.file.name),u.append("post_id",o.data("id")),u.append("action","dnd_codedropz_upload_chunks_wc"),s.chunkTransfer=e.ajax({url:t.ajax_url,type:h.attr("method"),dataType:"json",data:u,type:"POST",contentType:!1,processData:!1,cache:!1,success:function(o,d,i){s.currentChunk++,chunks_percentage=Math.ceil(s.currentChunk/s.totalChunks*100),l.progressBar.setProgress(s.progressbar,chunks_percentage),s.currentChunk<s.totalChunks&&l.uploadChunks(a,s,n),console.log(s.name+" [chunk -"+s.currentChunk+" of "+s.totalChunks+"]"),o&&void 0!==o&&(s.complete=!0,r[n].uploaded++,l.processQueue(a,n),e.isFunction(t.on_success)&&t.on_success.call(this,s.progressbar,o,n,r[n]))},error:function(r,o,t){e("#"+s.progressbar).find(".dnd-upload-details").append('<span class="has-error">'+t+"</span>"),s.error=!0,l.processQueue(a,n)}})},sliceFile:function(e,a,r){return(e.mozSlice?e.mozSlice:e.webkitSlice?e.webkitSlice:e.slice?e.slice:{}).bind(e)(a,r)},bytesToSize:function(e){return 0===e?"0":(kBytes=e/1024,fileSize=kBytes>=1024?(kBytes/1024).toFixed(2)+"MB":kBytes.toFixed(2)+"KB",fileSize)}};f.init()})}}(jQuery);